name: Gemini Code Assist

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  gemini-review:
    runs-on: ubuntu-latest
    # Trigger only on PR comments with "/gemini review"
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/gemini review')

    steps:
      - name: Add reaction
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: get-diff
        run: |
          # Get PR number from issue
          PR_NUMBER="${{ github.event.issue.number }}"
          gh pr diff $PR_NUMBER > pr.diff || echo "Failed to get diff"

          # Check if diff exists and is not empty
          if [ ! -s pr.diff ]; then
            echo "error=Unable to fetch PR diff" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get file count
          FILE_COUNT=$(gh pr view $PR_NUMBER --json files --jq '.files | length')
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

          # Check diff size
          DIFF_SIZE=$(wc -c < pr.diff)
          echo "diff_size=$DIFF_SIZE" >> $GITHUB_OUTPUT

          if [ $DIFF_SIZE -gt 50000 ]; then
            echo "error=Diff too large (>50KB)" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR metadata
        id: pr-metadata
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            core.setOutput('title', pr.title);
            core.setOutput('body', pr.body || 'No description provided');
            core.setOutput('author', pr.user.login);
            core.setOutput('base', pr.base.ref);
            core.setOutput('head', pr.head.ref);

      - name: Review with Gemini (Placeholder)
        id: gemini-review
        run: |
          # This is a placeholder for actual Gemini API integration
          # You can replace this with:
          # 1. Google Cloud Gemini API
          # 2. OpenAI API
          # 3. Anthropic Claude API
          # 4. Any other LLM service

          cat > review.md << 'EOF'
          ## ü§ñ Gemini Code Assist Review

          ### üìä Analysis Summary

          **PR Title:** ${{ steps.pr-metadata.outputs.title }}
          **Author:** @${{ steps.pr-metadata.outputs.author }}
          **Files Changed:** ${{ steps.get-diff.outputs.file_count }}
          **Diff Size:** ${{ steps.get-diff.outputs.diff_size }} bytes

          ### üîç Code Review

          To enable AI-powered reviews, you need to:

          1. **Add API credentials** to GitHub Secrets:
             - `GEMINI_API_KEY` (Google AI Studio)
             - OR `OPENAI_API_KEY` (OpenAI)
             - OR `ANTHROPIC_API_KEY` (Claude)

          2. **Modify this workflow** to call the AI API

          ### üìã Manual Review Checklist

          Based on the project's **CLAUDE.md** guidelines, verify:

          #### üîí Security
          - [ ] Authentication uses `requireAuthentication` helper
          - [ ] Authorization uses `requireAuthorization` for protected routes
          - [ ] All inputs validated with Zod schemas
          - [ ] No sensitive data in JWT payloads
          - [ ] No manual cookie parsing (use `betterFetch`)

          #### ‚ö° Performance
          - [ ] Prisma queries use specific `select`
          - [ ] External API calls cached in Redis
          - [ ] React Query used for server state (not Zustand)
          - [ ] Images optimized with Sharp before S3 upload
          - [ ] Complex DB operations use Prisma transactions

          #### üö® Error Handling
          - [ ] `ApiHandler.handleError()` used for consistency
          - [ ] Errors logged with LoggingService
          - [ ] Proper error hierarchy (`ServerActionError` > `ServiceError`)
          - [ ] Toast notifications for client errors

          #### üé® Code Style
          - [ ] ESLint passes (`npm run lint`)
          - [ ] Build succeeds (`npm run build`)
          - [ ] Imports organized correctly
          - [ ] No `any` types (TypeScript strict mode)

          #### üèóÔ∏è Architecture
          - [ ] Server Actions follow pattern: Auth ‚Üí Validation ‚Üí Transaction ‚Üí Response
          - [ ] Services contain business logic
          - [ ] Components are presentational only
          - [ ] Background jobs use Inngest
          - [ ] Notifications use `sendSystemNotification` in Inngest

          ### üîó Useful Commands

          ```bash
          # Test locally
          npm run build
          npm run lint

          # Check for type errors
          npx tsc --noEmit

          # View Prisma queries
          npm run prisma:studio
          ```

          ### üí° Recommendations

          1. Review the [architecture patterns](docs/agent/patterns/)
          2. Check [troubleshooting guide](docs/agent/operations/troubleshooting.md) if needed
          3. Test critical features (auth, database, forms)

          ---

          *ü§ñ To enable AI-powered reviews, configure API keys in repository secrets*
          EOF

          cat review.md

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review.md', 'utf8');

            // Add success reaction
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

            // Post review
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review
            });

      - name: Handle errors
        if: steps.get-diff.outputs.error != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const error = '${{ steps.get-diff.outputs.error }}';

            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'confused'
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ‚ùå Review Failed\n\n**Error:** ${error}\n\nPlease try again or review manually.`
            });
