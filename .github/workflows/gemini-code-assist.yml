name: Gemini Code Assist

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  gemini-review:
    runs-on: ubuntu-latest
    # Trigger only on PR comments with "/gemini review"
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/gemini review')

    steps:
      - name: Add reaction
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: get-diff
        run: |
          # Get PR number from issue
          PR_NUMBER="${{ github.event.issue.number }}"
          gh pr diff $PR_NUMBER > pr.diff || echo "Failed to get diff"

          # Check if diff exists and is not empty
          if [ ! -s pr.diff ]; then
            echo "error=Unable to fetch PR diff" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get file count
          FILE_COUNT=$(gh pr view $PR_NUMBER --json files --jq '.files | length')
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

          # Check diff size
          DIFF_SIZE=$(wc -c < pr.diff)
          echo "diff_size=$DIFF_SIZE" >> $GITHUB_OUTPUT

          if [ $DIFF_SIZE -gt 50000 ]; then
            echo "error=Diff too large (>50KB)" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR metadata
        id: pr-metadata
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            core.setOutput('title', pr.title);
            core.setOutput('body', pr.body || 'No description provided');
            core.setOutput('author', pr.user.login);
            core.setOutput('base', pr.base.ref);
            core.setOutput('head', pr.head.ref);

      - name: Review with Gemini AI
        id: gemini-review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Check if API key is configured
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "‚ö†Ô∏è GEMINI_API_KEY not configured. Using fallback template."
            USE_AI=false
          else
            USE_AI=true
          fi

          # Read the PR diff
          DIFF_CONTENT=$(cat pr.diff | head -c 10000)  # Limit to 10KB for API
          PR_TITLE="${{ steps.pr-metadata.outputs.title }}"
          PR_BODY="${{ steps.pr-metadata.outputs.body }}"

          # Prepare the context for AI review
          CLAUDE_MD_GUIDELINES=$(cat << 'GUIDELINES'
          ## MANDATORY Development Rules

          ### Security Rules (CRITICAL)
          1. NEVER manually parse cookies - use betterFetch
          2. ALWAYS validate session in Server Actions using auth helpers
          3. ALWAYS use centralized authorization helpers
          4. ALWAYS sanitize/validate inputs with Zod
          5. NEVER expose sensitive data in JWT payloads

          ### Performance Rules (CRITICAL)
          1. Use specific select in Prisma queries
          2. Implement Redis cache for external APIs
          3. Use React Query for client-side data fetching
          4. Optimize images with Sharp before S3 upload
          5. Use Prisma transactions for complex operations

          ### Error Handling Rules (CRITICAL)
          1. ALWAYS use ApiHandler.handleError() for consistency
          2. ALWAYS log errors with LoggingService automatically
          3. Use error hierarchy: ServerActionError > ServiceError
          4. Handle errors with toast notifications on client
          5. Provide context (fileName, functionName) for all errors

          ### Architecture Patterns (MANDATORY)
          1. Server Actions: Auth ‚Üí Validation ‚Üí Transaction ‚Üí Response
          2. Authentication helpers: requireAuthentication, requireAuthorization
          3. State: React Query for server state, NOT Zustand
          4. Background Jobs: Inngest for async operations
          5. Notifications: sendSystemNotification for Inngest context
          GUIDELINES
          )

          if [ "$USE_AI" = true ]; then
            # Call Gemini API
            PROMPT="You are a code reviewer for a Next.js 15 project with strict quality standards.

          Review this pull request and provide analysis based on these project guidelines:
          $CLAUDE_MD_GUIDELINES

          PR Title: $PR_TITLE
          PR Description: $PR_BODY

          Diff (first 10KB):
          \`\`\`diff
          $DIFF_CONTENT
          \`\`\`

          Provide a concise review focusing on:
          1. Security issues (auth, validation, data exposure)
          2. Performance concerns (queries, caching, optimization)
          3. Error handling (ApiHandler usage, logging)
          4. Architecture compliance (Server Actions pattern, services)
          5. Code quality (TypeScript, imports, naming)

          Format your response as markdown with clear sections and checkboxes for actionable items."

            # Make API request to Gemini
            REVIEW_RESPONSE=$(curl -s -X POST \
              "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GEMINI_API_KEY" \
              -H 'Content-Type: application/json' \
              -d "{
                \"contents\":[{
                  \"parts\":[{\"text\":$(echo "$PROMPT" | jq -Rs .)}]
                }],
                \"generationConfig\":{
                  \"temperature\":0.3,
                  \"maxOutputTokens\":2048
                }
              }")

            # Extract the AI response
            AI_REVIEW=$(echo "$REVIEW_RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "‚ùå Failed to generate AI review"')

            # Create review with AI analysis
            cat > review.md << EOF
          ## ü§ñ Gemini AI Code Review

          ### üìä PR Summary
          **Title:** $PR_TITLE
          **Author:** @${{ steps.pr-metadata.outputs.author }}
          **Files Changed:** ${{ steps.get-diff.outputs.file_count }}
          **Diff Size:** ${{ steps.get-diff.outputs.diff_size }} bytes

          ---

          ### üîç AI Analysis

          $AI_REVIEW

          ---

          ### üîó Useful Commands

          \`\`\`bash
          # Test locally
          npm run build
          npm run lint

          # Check for type errors
          npx tsc --noEmit
          \`\`\`

          ---

          *ü§ñ Powered by Gemini 1.5 Flash | [Project Guidelines](https://github.com/${{ github.repository }}/blob/master/CLAUDE.md)*
          EOF
          else
            # Fallback to template checklist if no API key
            cat > review.md << 'EOF'
          ## ü§ñ Gemini Code Assist Review

          ### üìä Analysis Summary

          **PR Title:** ${{ steps.pr-metadata.outputs.title }}
          **Author:** @${{ steps.pr-metadata.outputs.author }}
          **Files Changed:** ${{ steps.get-diff.outputs.file_count }}
          **Diff Size:** ${{ steps.get-diff.outputs.diff_size }} bytes

          ### ‚ö†Ô∏è AI Review Disabled

          **GEMINI_API_KEY** not configured. To enable AI-powered reviews:

          1. Get free API key from [Google AI Studio](https://aistudio.google.com/)
          2. Add to repository secrets: Settings ‚Üí Secrets ‚Üí `GEMINI_API_KEY`

          ### üìã Manual Review Checklist

          Based on the project's **CLAUDE.md** guidelines, verify:

          #### üîí Security
          - [ ] Authentication uses `requireAuthentication` helper
          - [ ] Authorization uses `requireAuthorization` for protected routes
          - [ ] All inputs validated with Zod schemas
          - [ ] No sensitive data in JWT payloads
          - [ ] No manual cookie parsing (use `betterFetch`)

          #### ‚ö° Performance
          - [ ] Prisma queries use specific `select`
          - [ ] External API calls cached in Redis
          - [ ] React Query used for server state (not Zustand)
          - [ ] Images optimized with Sharp before S3 upload
          - [ ] Complex DB operations use Prisma transactions

          #### üö® Error Handling
          - [ ] `ApiHandler.handleError()` used for consistency
          - [ ] Errors logged with LoggingService
          - [ ] Proper error hierarchy (`ServerActionError` > `ServiceError`)
          - [ ] Toast notifications for client errors

          #### üé® Code Style
          - [ ] ESLint passes (`npm run lint`)
          - [ ] Build succeeds (`npm run build`)
          - [ ] Imports organized correctly
          - [ ] No `any` types (TypeScript strict mode)

          #### üèóÔ∏è Architecture
          - [ ] Server Actions follow pattern: Auth ‚Üí Validation ‚Üí Transaction ‚Üí Response
          - [ ] Services contain business logic
          - [ ] Components are presentational only
          - [ ] Background jobs use Inngest
          - [ ] Notifications use `sendSystemNotification` in Inngest

          ### üîó Useful Commands

          ```bash
          # Test locally
          npm run build
          npm run lint

          # Check for type errors
          npx tsc --noEmit

          # View Prisma queries
          npm run prisma:studio
          ```

          ### üí° Recommendations

          1. Review the [architecture patterns](docs/agent/patterns/)
          2. Check [troubleshooting guide](docs/agent/operations/troubleshooting.md) if needed
          3. Test critical features (auth, database, forms)

          ---

          *ü§ñ To enable AI-powered reviews, configure GEMINI_API_KEY in repository secrets*
          EOF
          fi

          cat review.md

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review.md', 'utf8');

            // Add success reaction
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

            // Post review
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review
            });

      - name: Handle errors
        if: steps.get-diff.outputs.error != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const error = '${{ steps.get-diff.outputs.error }}';

            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'confused'
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ‚ùå Review Failed\n\n**Error:** ${error}\n\nPlease try again or review manually.`
            });
