name: Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    # Only run on Dependabot PRs or when explicitly requested
    if: |
      github.event_name == 'pull_request' &&
      (github.actor == 'dependabot[bot]' || contains(github.event.pull_request.title, '[gemini]')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/gemini review'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        if: github.event_name == 'pull_request'
        run: |
          # Get the PR number
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Fetch the diff
          gh pr diff $PR_NUMBER > pr.diff

          # Check if diff is too large (> 10KB)
          DIFF_SIZE=$(wc -c < pr.diff)
          if [ $DIFF_SIZE -gt 10240 ]; then
            echo "diff_too_large=true" >> $GITHUB_OUTPUT
          else
            echo "diff_too_large=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Review with Gemini
        if: steps.diff.outputs.diff_too_large != 'true'
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}

      - name: Generate Gemini Review
        id: gemini
        run: |
          # Read the diff
          DIFF_CONTENT=$(cat pr.diff)

          # Get PR details
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          # Create prompt for Gemini
          cat > prompt.txt << 'EOF'
          You are an expert code reviewer for a Next.js 15 application using:
          - Framework: Next.js 15 with App Router & Server Actions
          - Database: PostgreSQL with Prisma ORM
          - Authentication: better-auth
          - Validation: Zod schemas

          Review this Pull Request and provide:

          1. **Summary**: Brief overview of changes (2-3 sentences)
          2. **Breaking Changes**: Any potential breaking changes or compatibility issues
          3. **Security Impact**: Security implications (especially for auth, database, validation)
          4. **Performance Impact**: Performance considerations
          5. **Recommendation**: Approve, Request Changes, or Needs Testing

          Be concise and focus on:
          - Dependency compatibility issues
          - Breaking changes that affect the tech stack above
          - Security vulnerabilities
          - Performance regressions

          PR Title: $PR_TITLE

          PR Description:
          $PR_BODY

          Changes:
          $DIFF_CONTENT
          EOF

          # Call Gemini API (placeholder - you'll need to implement actual API call)
          # For now, we'll use a simple comment
          echo "Review generated for PR #${{ github.event.pull_request.number }}"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const isDependabot = context.actor === 'dependabot[bot]';

            let comment = '## ðŸ¤– Gemini Code Review\n\n';

            if (isDependabot) {
              comment += `### ðŸ“¦ Dependency Update Analysis\n\n`;
              comment += `This is a Dependabot PR. Here's what to check:\n\n`;
              comment += `- âœ… **Build Status**: Wait for CI/CD checks to complete\n`;
              comment += `- âœ… **Breaking Changes**: Review the changelog for breaking changes\n`;
              comment += `- âœ… **Compatibility**: Check compatibility with Next.js 15, React 19, and Prisma\n`;
              comment += `- âœ… **Security**: Review for known vulnerabilities\n\n`;
              comment += `### ðŸ“ Recommended Actions:\n\n`;
              comment += `1. Review the [CHANGELOG](https://github.com/search?q=changelog) for this package\n`;
              comment += `2. Run \`npm run build\` and \`npm run lint\` locally\n`;
              comment += `3. Test critical features (auth, database, forms)\n`;
              comment += `4. If all checks pass, approve and merge\n\n`;
              comment += `---\n`;
              comment += `*To trigger a full Gemini review, comment \`/gemini review\`*`;
            } else {
              comment += `A detailed Gemini Code Assist review will be added here.\n\n`;
              comment += `For now, please review the changes manually and ensure:\n`;
              comment += `- Code follows project standards (see CLAUDE.md)\n`;
              comment += `- Tests pass\n`;
              comment += `- No security vulnerabilities introduced\n`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
